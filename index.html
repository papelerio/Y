<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameCode Vault Premium</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-main: #ffffff;
            --accent-blue: #3498db;
            --accent-green: #90eadb;
            --accent-yellow: #f9ff9e;
            --accent-orange: #ffa500;
            --dark-bg: #0f2027;
            --board-bg: #1a2b3c;
            --code-bg: #0c141c;
            --reorder-highlight: rgba(46, 204, 113, 0.3);
            --reorder-selected: rgba(46, 204, 113, 0.7);
            --vignette-size: 180px;
            --vignette-gap: 15px;
        }
        
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            background-color: var(--dark-bg); 
            color: var(--text-main);
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
        }

        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
            background-size: cover;
            background-position: center;
            transition: background-image 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #bg-dimmer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.7) 100%);
        }

        /* ENCABEZADO */
        header { 
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 15px 25px; 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            border-bottom: 1px solid var(--glass-border);
            z-index: 10;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            min-height: 70px;
        }
        
        #category-container { 
            display: flex; 
            overflow-x: auto; 
            gap: 10px; 
            flex: 1;
            scrollbar-width: none;
        }
        #category-container::-webkit-scrollbar { display: none; }
        
        .category-btn { 
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.7);
            border: 1px solid var(--glass-border);
            padding: 10px 20px; 
            cursor: pointer; 
            white-space: nowrap; 
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .category-btn.active { 
            background: var(--accent-blue);
            color: white; 
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
            transform: translateY(-2px);
        }
        .category-btn:hover:not(.active) {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        /* BUSCADOR Y BOTONES */
        .search-section { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: rgba(0,0,0,0.3); 
            padding: 5px 10px; 
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }
        #main-search { 
            background: transparent;
            border: none;
            color: white;
            padding: 8px; 
            width: 200px; 
            outline: none;
            font-size: 0.9rem;
        }
        #main-search::placeholder { color: rgba(255,255,255,0.4); }

        .action-group { 
            display: flex; 
            gap: 10px; 
            align-items: center;
        }
        .ui-btn { 
            border: none; 
            padding: 10px 15px; 
            cursor: pointer; 
            font-weight: bold; 
            border-radius: 8px; 
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        .ui-btn:hover { transform: scale(1.05); filter: brightness(1.2); }

        /* CONTROLES DE TAMA√ëO DE VI√ëETAS */
        .size-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.2);
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }
        
        .size-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .size-btn:hover {
            background: var(--accent-blue);
        }
        
        .size-btn.active {
            background: var(--accent-blue);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        .size-indicator {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            margin: 0 5px;
            min-width: 60px;
            text-align: center;
        }

        /* CONTENIDO PRINCIPAL - VI√ëETAS */
        #vignette-container { 
            flex: 1;
            padding: 20px; 
            overflow-y: auto; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(var(--vignette-size), 1fr)); 
            gap: var(--vignette-gap);
            transition: all 0.3s ease;
        }
        
        /* VI√ëETA COMPACTA */
        .vignette {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            overflow: hidden;
            height: calc(var(--vignette-size) * 1.1);
            display: flex;
            flex-direction: column;
            user-select: none;
        }
        .vignette:hover { 
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
        }
        
        .vignette.reorder-selected {
            border: 2px solid #2ecc71;
            background: var(--reorder-selected);
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
            transform: scale(1.02);
        }
        
        .vignette.reorder-target {
            border: 2px dashed #2ecc71;
            background: var(--reorder-highlight);
        }
        
        .vignette-order {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--accent-yellow);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 1;
        }
        
        .vignette-id {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: #90ee90;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-family: monospace;
            z-index: 1;
        }
        
        .reorder-indicator {
            position: absolute;
            top: 30px;
            right: 5px;
            background: #2ecc71;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 1;
            animation: pulse 2s infinite;
        }
        
        .reorder-arrow {
            position: absolute;
            top: 50%;
            left: -25px;
            transform: translateY(-50%);
            background: #2ecc71;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 2;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { left: -40px; opacity: 0; }
            to { left: -25px; opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .vignette-image {
            height: calc(var(--vignette-size) * 0.6);
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px 8px 0 0;
        }
        .vignette-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .vignette-image.default {
            background: linear-gradient(135deg, #555 0%, #777 100%);
        }
        .vignette-image.default::after {
            content: "No image";
            color: rgba(255,255,255,0.5);
            font-size: 12px;
        }
        
        .vignette-title {
            padding: 8px 12px 4px 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-green);
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .vignette-description {
            padding: 0 12px;
            font-size: 11px;
            color: var(--accent-orange);
            opacity: 0.9;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            flex-grow: 1;
        }
        
        .vignette-tags {
            padding: 0 12px 8px 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .tag {
            background: rgba(52, 152, 219, 0.2);
            color: var(--accent-blue);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        /* PIZARRA */
        #board {
            width: 45%;
            background: var(--board-bg);
            border-left: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .board-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
        }
        
        .board-header h2 {
            margin: 0 0 10px 0;
            color: var(--accent-green);
            font-size: 1.5rem;
        }
        
        .board-description {
            margin: 0 0 15px 0;
            color: var(--accent-orange);
            font-size: 14px;
            font-style: italic;
        }
        
        .board-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .board-tag {
            background: rgba(52, 152, 219, 0.3);
            color: var(--accent-blue);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid rgba(52, 152, 219, 0.4);
        }
        
        .board-actions {
            display: flex;
            gap: 10px;
        }
        
        .board-btn {
            padding: 8px 16px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .board-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .board-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .board-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .board-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .code-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--code-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .code-header {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .code-header span {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .code-editor {
            width: 100%;
            height: 100%;
            padding: 15px;
            background: transparent;
            color: #90ee90;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            border: none;
            outline: none;
            resize: none;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            overflow-x: hidden;
            overflow-y: auto;
            tab-size: 4;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .code-editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--code-bg);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .code-editor::selection {
            background: rgba(52, 152, 219, 0.5);
        }
        
        .empty-board {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.2rem;
            text-align: center;
            padding: 40px;
        }

        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--dark-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            color: var(--accent-green);
        }
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-modal:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Consolas', monospace;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .required::after {
            content: " *";
            color: #ff6b6b;
        }
        
        /* SUGERENCIAS DE TAGS */
        .tags-container {
            position: relative;
        }
        
        .tags-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            min-height: 44px;
        }
        
        .tag-input {
            flex: 1;
            background: none;
            border: none;
            color: white;
            min-width: 100px;
            outline: none;
            font-size: 14px;
        }
        
        .tag-suggestion-box {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 30, 40, 0.95);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }
        
        .tag-suggestion-box.active {
            display: block;
        }
        
        .tag-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .tag-suggestion:hover {
            background: var(--accent-blue);
        }
        
        .input-tag {
            display: inline-flex;
            align-items: center;
            background: rgba(52, 152, 219, 0.2);
            color: var(--accent-blue);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            gap: 5px;
        }
        
        .remove-tag {
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        
        .remove-tag:hover {
            color: #ff6b6b;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px;
            border-top: 1px solid var(--glass-border);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        /* MEN√ö CONTEXTUAL */
        #context-menu {
            display: none; position: fixed; background: rgba(20, 20, 20, 0.95); 
            border: 1px solid var(--glass-border); border-radius: 8px;
            box-shadow: 10px 10px 30px rgba(0,0,0,0.5); z-index: 1000; overflow: hidden;
            backdrop-filter: blur(10px);
        }
        #context-menu button {
            display: block; width: 100%; padding: 12px 20px; border: none;
            background: none; text-align: left; cursor: pointer; color: white; font-size: 14px;
        }
        #context-menu button:hover { background: var(--accent-blue); }
        
        .vignette-context-menu {
            display: none; position: fixed; background: rgba(20, 20, 20, 0.95); 
            border: 1px solid var(--glass-border); border-radius: 8px;
            box-shadow: 10px 10px 30px rgba(0,0,0,0.5); z-index: 1001; overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .vignette-context-menu button {
            display: block; width: 100%; padding: 12px 20px; border: none;
            background: none; text-align: left; cursor: pointer; color: white; font-size: 14px;
        }
        .vignette-context-menu button:hover { background: var(--accent-blue); }

        /* INSTRUCCIONES DE REORDENAMIENTO */
        .reorder-instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 30, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            z-index: 999;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }
        
        .reorder-instructions.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { bottom: -100px; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }
        
        .reorder-instructions h3 {
            margin: 0 0 10px 0;
            color: var(--accent-green);
        }
        
        .reorder-instructions p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .reorder-instructions .steps {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .reorder-instructions .step {
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            #board {
                width: 50%;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            #board {
                width: 100%;
                height: 50vh;
                border-left: none;
                border-top: 1px solid var(--glass-border);
            }
            
            #vignette-container {
                height: 50vh;
                overflow-y: auto;
            }
            
            .reorder-instructions {
                width: 90%;
                left: 5%;
                transform: none;
            }
            
            .action-group {
                flex-wrap: wrap;
                justify-content: flex-end;
            }
            
            .size-controls {
                order: -1;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>

<div id="bg-overlay"></div>
<div id="bg-dimmer"></div>

<header>
    <div id="category-container"></div>
    
    <div class="search-section">
        <input type="text" id="main-search" placeholder="Buscar comando..." oninput="handleSearch()">
    </div>

    <div class="size-controls">
        <button class="size-btn" onclick="changeVignetteSize('small')" title="Vi√±etas peque√±as">S</button>
        <button class="size-btn active" onclick="changeVignetteSize('medium')" title="Vi√±etas medianas">M</button>
        <button class="size-btn" onclick="changeVignetteSize('large')" title="Vi√±etas grandes">L</button>
        <span class="size-indicator" id="size-indicator">Mediano</span>
    </div>

    <div class="action-group">
        <button class="ui-btn" style="background-color: var(--accent-blue); color: white;" onclick="addCategory()" title="Nueva Carpeta">+ Carpeta</button>
        <button class="ui-btn" style="background-color: var(--accent-green); color: #222;" onclick="openModal()" title="Nueva Nota">+ Nota</button>
        <button class="ui-btn" style="background-color: var(--accent-yellow); color: #222;" onclick="toggleReorderMode()" title="Reordenar notas">‚ÜïÔ∏è</button>
        <button class="ui-btn" style="background-color: #9b59b6; color: white;" onclick="saveToFirebase()" title="Guardar en Firebase">üíæ Guardar</button>
        <button class="ui-btn" style="background-color: #e74c3c; color: white;" onclick="loadFromFirebase()" title="Cargar desde Firebase">üì• Cargar</button>
    </div>
</header>

<div class="app-container">
    <main id="vignette-container"></main>
    
    <!-- PIZARRA -->
    <aside id="board">
        <div class="board-header">
            <h2 id="board-title">Pizarra de C√≥digo</h2>
            <div id="board-description" class="board-description"></div>
            <div class="board-tags" id="board-tags"></div>
            <div class="board-actions">
                <button class="board-btn" onclick="copyBoardCode()">üìã Copiar c√≥digo</button>
                <button class="board-btn secondary" onclick="clearBoard()">üóëÔ∏è Limpiar pizarra</button>
            </div>
        </div>
        
        <div class="board-content">
            <div id="board-empty" class="empty-board">
                <div>
                    <div style="font-size: 3rem; margin-bottom: 20px;">üìù</div>
                    <p>Selecciona una nota para cargar su c√≥digo en la pizarra</p>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: rgba(255,255,255,0.4);">
                        El c√≥digo en la pizarra es editable y temporal
                    </p>
                </div>
            </div>
            
            <div id="board-content" style="display: none; flex: 1; flex-direction: column;">
                <div class="code-container">
                    <div class="code-header">
                        <span>C√≥digo editable</span>
                        <button class="board-btn" style="padding: 5px 10px; font-size: 12px;" onclick="copyBoardCode()">üìã Copiar</button>
                    </div>
                    <div class="code-editor-container">
                        <textarea id="board-code" class="code-editor" placeholder="El c√≥digo aparecer√° aqu√≠..." spellcheck="false"></textarea>
                    </div>
                </div>
                
                <div style="padding: 15px; color: rgba(255,255,255,0.6); font-size: 12px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-top: 15px;">
                    üí° <strong>Nota:</strong> Los cambios en la pizarra son temporales. Haz clic en la misma nota nuevamente para restaurar el c√≥digo original.
                </div>
            </div>
        </div>
    </aside>
</div>

<!-- MODAL PARA A√ëADIR/EDITAR NOTA -->
<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modal-title">Nueva Nota</h2>
            <button class="close-modal" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="snippet-title" class="required">T√≠tulo</label>
                <input type="text" id="snippet-title" placeholder="Nombre del comando o c√≥digo">
            </div>
            
            <div class="form-group">
                <label for="snippet-description">Descripci√≥n (opcional)</label>
                <textarea id="snippet-description" placeholder="Describe brevemente este c√≥digo..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="snippet-image">Link de una imagen (opcional)</label>
                <input type="text" id="snippet-image" placeholder="https://ejemplo.com/imagen.jpg">
                <small style="color: rgba(255,255,255,0.5); font-size: 12px;">Si no se coloca, se usar√° un cuadro gris</small>
            </div>
            
            <div class="form-group">
                <label for="snippet-code" class="required">C√≥digo</label>
                <textarea id="snippet-code" placeholder="Pega aqu√≠ tu c√≥digo..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="snippet-tags">Tags (opcional)</label>
                <div class="tags-container">
                    <div class="tags-input-container" onclick="document.getElementById('tag-input').focus()">
                        <div id="tag-display"></div>
                        <input type="text" id="tag-input" class="tag-input" placeholder="Escribe tags separados por coma" oninput="updateTagSuggestions()">
                    </div>
                    <div id="tag-suggestions" class="tag-suggestion-box"></div>
                </div>
                <small style="color: rgba(255,255,255,0.5); font-size: 12px;">Separa con comas o presiona Enter. Tags existentes: <span id="existing-tags-count">0</span></small>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveSnippet()">Guardar Nota</button>
        </div>
    </div>
</div>

<!-- MEN√ö CONTEXTUAL PARA CARPETAS -->
<div id="context-menu">
    <button onclick="renameCategory()">‚úèÔ∏è Renombrar</button>
    <button onclick="setBackground()">üñºÔ∏è Cambiar fondo</button>
    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 0;">
    <button onclick="deleteCategory()" style="color:#ff6b6b;">üóëÔ∏è Eliminar</button>
</div>

<!-- MEN√ö CONTEXTUAL PARA NOTAS -->
<div id="vignette-context-menu" class="vignette-context-menu">
    <button onclick="editVignette()">‚úèÔ∏è Editar</button>
    <button onclick="copyVignetteCode()">üìã Copiar c√≥digo</button>
    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 0;">
    <button onclick="deleteVignette()" style="color:#ff6b6b;">üóëÔ∏è Eliminar</button>
</div>

<!-- INSTRUCCIONES DE REORDENAMIENTO -->
<div id="reorder-instructions" class="reorder-instructions">
    <h3>üìã Modo Reordenamiento</h3>
    <p>1. <strong>Haz clic</strong> en una nota para seleccionarla (se pondr√° verde)</p>
    <p>2. <strong>Mueve el mouse</strong> sobre otra nota para definir la posici√≥n</p>
    <p>3. <strong>Haz clic</strong> en la segunda nota para posicionar la seleccionada</p>
    <div class="steps">
        <span class="step">Primer clic: Seleccionar</span>
        <span class="step">Mouseover: Previsualizar</span>
        <span class="step">Segundo clic: Posicionar</span>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCwtI9nF1Xs5i2PEhKjCdNPMTKnWoFPijI",
        authDomain: "almacen-minecraf.firebaseapp.com",
        databaseURL: "https://almacen-minecraf-default-rtdb.firebaseio.com",
        projectId: "almacen-minecraf",
        storageBucket: "almacen-minecraf.firebasestorage.app",
        messagingSenderId: "191590928401",
        appId: "1:191590928401:web:16e13d1be65d99ac60a1b0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Generador de ID de 5 d√≠gitos alfanum√©rico
    function generate5DigitId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 5; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    // ESTRUCTURA DE DATOS INICIAL VAC√çA
    let state = {
        folders: [],
        notes: {},
        settings: {
            activeFolderId: null,
            searchTerm: "",
            lastUpdated: null,
            vignetteSize: "medium" // small, medium, large
        }
    };

    // Cargar datos locales de forma segura
    function loadLocalData() {
        try {
            const localData = localStorage.getItem('vaultCache');
            if (localData) {
                const parsed = JSON.parse(localData);
                if (parsed) {
                    state = {
                        folders: Array.isArray(parsed.folders) ? parsed.folders : [],
                        notes: parsed.notes && typeof parsed.notes === 'object' ? parsed.notes : {},
                        settings: {
                            activeFolderId: parsed.settings?.activeFolderId || null,
                            searchTerm: parsed.settings?.searchTerm || "",
                            lastUpdated: parsed.settings?.lastUpdated || null,
                            vignetteSize: parsed.settings?.vignetteSize || "medium"
                        }
                    };
                    // Asegurar que todas las carpetas tengan noteOrder
                    if (state.folders) {
                        state.folders.forEach(folder => {
                            if (folder && !folder.noteOrder) {
                                folder.noteOrder = [];
                            }
                        });
                    }
                }
            }
        } catch (e) {
            console.error("Error al cargar datos locales:", e);
        }
    }

    // Cargar datos iniciales
    loadLocalData();

    // Variables globales
    let selectedCatContext = null;
    let selectedVignetteId = null;
    let currentTags = [];
    let allTags = new Set();
    let editingSnippetId = null;
    let currentBoardSnippet = null;
    let originalBoardCode = "";
    let isReorderMode = false;
    let reorderSelectedId = null;
    let reorderTargetId = null;

    // ========== CONTROL DE TAMA√ëO DE VI√ëETAS ==========
    
    window.changeVignetteSize = function(size) {
        if (!['small', 'medium', 'large'].includes(size)) return;
        
        state.settings.vignetteSize = size;
        
        // Actualizar botones activos
        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (size === 'small') {
            document.querySelector('.size-btn[title*="peque√±as"]').classList.add('active');
            document.getElementById('size-indicator').textContent = 'Peque√±o';
        } else if (size === 'medium') {
            document.querySelector('.size-btn[title*="medianas"]').classList.add('active');
            document.getElementById('size-indicator').textContent = 'Mediano';
        } else if (size === 'large') {
            document.querySelector('.size-btn[title*="grandes"]').classList.add('active');
            document.getElementById('size-indicator').textContent = 'Grande';
        }
        
        // Aplicar tama√±o
        applyVignetteSize();
        saveLocal();
    };
    
    function applyVignetteSize() {
        const root = document.documentElement;
        let size, gap;
        
        switch(state.settings.vignetteSize) {
            case 'small':
                size = 140;
                gap = 10;
                break;
            case 'medium':
                size = 180;
                gap = 15;
                break;
            case 'large':
                size = 220;
                gap = 20;
                break;
            default:
                size = 180;
                gap = 15;
        }
        
        root.style.setProperty('--vignette-size', `${size}px`);
        root.style.setProperty('--vignette-gap', `${gap}px`);
    }

    // ========== REORDENAMIENTO SIMPLIFICADO ==========
    
    window.toggleReorderMode = function() {
        isReorderMode = !isReorderMode;
        reorderSelectedId = null;
        reorderTargetId = null;
        
        const reorderBtn = document.querySelector('.ui-btn[title*="Reordenar"], .ui-btn[title*="Cancelar"]');
        if (reorderBtn) {
            if (isReorderMode) {
                reorderBtn.style.background = '#e74c3c';
                reorderBtn.style.color = 'white';
                reorderBtn.title = 'Cancelar reordenamiento';
                reorderBtn.textContent = '‚úñ Cancelar';
            } else {
                reorderBtn.style.background = 'var(--accent-yellow)';
                reorderBtn.style.color = '#222';
                reorderBtn.title = 'Reordenar notas';
                reorderBtn.textContent = '‚ÜïÔ∏è';
            }
        }
        
        render();
    };

    function exitReorderMode() {
        isReorderMode = false;
        reorderSelectedId = null;
        reorderTargetId = null;
        
        const reorderBtn = document.querySelector('.ui-btn[title*="Cancelar"], .ui-btn[title*="Reordenar"]');
        if (reorderBtn) {
            reorderBtn.style.background = 'var(--accent-yellow)';
            reorderBtn.style.color = '#222';
            reorderBtn.title = 'Reordenar notas';
            reorderBtn.textContent = '‚ÜïÔ∏è';
        }
        
        render();
    }

    function handleReorderClick(noteId) {
        if (!isReorderMode) return;
        
        if (reorderSelectedId === null) {
            reorderSelectedId = noteId;
            reorderTargetId = null;
            render();
        } else if (reorderSelectedId === noteId) {
            reorderSelectedId = null;
            reorderTargetId = null;
            render();
        } else {
            moveNoteToNewPosition(reorderSelectedId, noteId);
        }
    }

    function moveNoteToNewPosition(movingNoteId, targetNoteId) {
        const activeFolder = state.folders.find(f => f.id === state.settings.activeFolderId);
        if (!activeFolder) {
            console.error("Error: No hay carpeta activa seleccionada");
            exitReorderMode();
            return;
        }
        
        if (!activeFolder.noteOrder) {
            activeFolder.noteOrder = [];
        }
        
        if (!activeFolder.noteOrder.includes(movingNoteId) || !activeFolder.noteOrder.includes(targetNoteId)) {
            console.error("Error: Una de las notas no est√° en esta carpeta");
            exitReorderMode();
            return;
        }
        
        const newOrder = [...activeFolder.noteOrder];
        const movingIndex = newOrder.indexOf(movingNoteId);
        newOrder.splice(movingIndex, 1);
        const targetIndex = newOrder.indexOf(targetNoteId);
        newOrder.splice(targetIndex, 0, movingNoteId);
        
        activeFolder.noteOrder = newOrder;
        saveLocal();
        
        exitReorderMode();
        render();
    }

    // ========== RENDERIZADO PRINCIPAL ==========
    window.render = function() {
        const catContainer = document.getElementById('category-container');
        const vignetteContainer = document.getElementById('vignette-container');
        const bgOverlay = document.getElementById('bg-overlay');

        if (!catContainer || !vignetteContainer || !bgOverlay) return;

        catContainer.innerHTML = '';
        vignetteContainer.innerHTML = '';

        if (Array.isArray(state.folders)) {
            state.folders.forEach(folder => {
                if (!folder || !folder.id) return;
                
                const btn = document.createElement('button');
                btn.className = `category-btn ${state.settings.activeFolderId === folder.id ? 'active' : ''}`;
                btn.innerText = folder.name || 'Sin nombre';
                btn.onclick = () => { 
                    state.settings.activeFolderId = folder.id; 
                    render(); 
                    clearBoard();
                    exitReorderMode();
                };
                btn.oncontextmenu = (e) => { 
                    e.preventDefault(); 
                    selectedCatContext = folder.id; 
                    showContextMenu(e.pageX, e.pageY); 
                };
                catContainer.appendChild(btn);
            });
        }

        if (!state.folders || state.folders.length === 0) {
            catContainer.innerHTML = '<span style="color: rgba(255,255,255,0.5); font-style: italic;">No hay carpetas</span>';
        }

        if (!state.settings.activeFolderId && state.folders && state.folders.length > 0) {
            state.settings.activeFolderId = state.folders[0].id;
        }

        const activeFolder = state.folders ? state.folders.find(f => f && f.id === state.settings.activeFolderId) : null;
        if (activeFolder && activeFolder.bg) {
            bgOverlay.style.backgroundImage = `url('${activeFolder.bg}')`;
        } else {
            bgOverlay.style.backgroundImage = 'none';
        }

        if (activeFolder) {
            let noteIds = Array.isArray(activeFolder.noteOrder) ? activeFolder.noteOrder : [];
            let notesToDisplay = noteIds
                .map(id => state.notes && state.notes[id])
                .filter(note => note && typeof note === 'object');
            
            if (state.settings.searchTerm) {
                const searchTerm = state.settings.searchTerm.toLowerCase();
                notesToDisplay = notesToDisplay.filter(note => 
                    (note.title && note.title.toLowerCase().includes(searchTerm)) ||
                    (note.description && note.description.toLowerCase().includes(searchTerm)) ||
                    (note.tags && Array.isArray(note.tags) && note.tags.some(tag => 
                        tag && typeof tag === 'string' && tag.toLowerCase().includes(searchTerm)
                    )) ||
                    (note.code && note.code.toLowerCase().includes(searchTerm))
                );
            }
            
            notesToDisplay.forEach((note, index) => {
                if (!note || !note.id) return;
                
                const vignette = document.createElement('div');
                vignette.className = 'vignette';
                vignette.dataset.id = note.id;
                
                if (isReorderMode && note.id === reorderSelectedId) {
                    vignette.classList.add('reorder-selected');
                    const indicator = document.createElement('div');
                    indicator.className = 'reorder-indicator';
                    indicator.textContent = '1Ô∏è‚É£';
                    vignette.appendChild(indicator);
                }
                
                if (isReorderMode && note.id === reorderTargetId) {
                    vignette.classList.add('reorder-target');
                    
                    // Agregar flecha ‚¨ÖÔ∏è para indicar posici√≥n
                    const arrow = document.createElement('div');
                    arrow.className = 'reorder-arrow';
                    arrow.textContent = '‚¨ÖÔ∏è';
                    vignette.appendChild(arrow);
                }
                
                const orderDiv = document.createElement('div');
                orderDiv.className = 'vignette-order';
                orderDiv.textContent = index + 1;
                vignette.appendChild(orderDiv);
                
                const idDiv = document.createElement('div');
                idDiv.className = 'vignette-id';
                idDiv.textContent = note.id || '?????';
                vignette.appendChild(idDiv);
                
                const imageDiv = document.createElement('div');
                imageDiv.className = note.image ? 'vignette-image' : 'vignette-image default';
                if (note.image) {
                    const img = document.createElement('img');
                    img.src = note.image;
                    img.alt = note.title || 'Nota';
                    img.onerror = function() {
                        this.parentElement.className = 'vignette-image default';
                        this.remove();
                    };
                    imageDiv.appendChild(img);
                }
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'vignette-title';
                titleDiv.textContent = note.title || 'Sin t√≠tulo';
                
                // AGREGAR DESCRIPCI√ìN A LA VI√ëETA
                const descriptionDiv = document.createElement('div');
                descriptionDiv.className = 'vignette-description';
                descriptionDiv.textContent = note.description || '';
                if (!note.description) {
                    descriptionDiv.style.display = 'none';
                }
                
                const tagsDiv = document.createElement('div');
                tagsDiv.className = 'vignette-tags';
                if (note.tags && Array.isArray(note.tags)) {
                    note.tags.slice(0, 3).forEach(tag => {
                        if (!tag || typeof tag !== 'string') return;
                        const tagSpan = document.createElement('span');
                        tagSpan.className = 'tag';
                        tagSpan.textContent = tag;
                        tagsDiv.appendChild(tagSpan);
                    });
                    if (note.tags.length > 3) {
                        const moreTag = document.createElement('span');
                        moreTag.className = 'tag';
                        moreTag.textContent = `+${note.tags.length - 3}`;
                        tagsDiv.appendChild(moreTag);
                    }
                }
                
                vignette.appendChild(imageDiv);
                vignette.appendChild(titleDiv);
                vignette.appendChild(descriptionDiv);
                vignette.appendChild(tagsDiv);
                
                if (isReorderMode) {
                    vignette.onclick = (e) => {
                        e.stopPropagation();
                        handleReorderClick(note.id);
                    };
                    
                    vignette.onmouseenter = () => {
                        if (reorderSelectedId !== null && note.id !== reorderSelectedId) {
                            reorderTargetId = note.id;
                            updateVignetteClasses();
                        }
                    };
                    
                    vignette.onmouseleave = () => {
                        if (reorderTargetId === note.id) {
                            reorderTargetId = null;
                            updateVignetteClasses();
                        }
                    };
                } else {
                    vignette.onclick = () => {
                        loadSnippetToBoard(note.id);
                    };
                    
                    vignette.oncontextmenu = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        selectedVignetteId = note.id;
                        showVignetteContextMenu(e.pageX, e.pageY);
                    };
                }
                
                vignetteContainer.appendChild(vignette);
            });
            
            if (notesToDisplay.length === 0) {
                vignetteContainer.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìÑ</div>
                        <p>${state.settings.searchTerm ? 'No se encontraron notas' : 'No hay notas en esta carpeta'}</p>
                        ${!state.settings.searchTerm ? '<p style="font-size: 0.9rem;">Haz clic en ‚òÖ para crear una nueva nota</p>' : ''}
                    </div>
                `;
            }
        } else {
            vignetteContainer.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üìÅ</div>
                    <p>No hay carpeta seleccionada</p>
                    <p style="font-size: 0.9rem;">Haz clic en + Carpeta para crear una nueva</p>
                </div>
            `;
        }
        
        updateReorderInstructions();
        updateAllTags();
    };

    // Funci√≥n para actualizar solo las clases de las vi√±etas
    function updateVignetteClasses() {
        document.querySelectorAll('.vignette').forEach(vignette => {
            const noteId = vignette.dataset.id;
            vignette.classList.remove('reorder-selected', 'reorder-target');
            
            // Remover flechas existentes
            const existingArrow = vignette.querySelector('.reorder-arrow');
            if (existingArrow) {
                existingArrow.remove();
            }
            
            if (noteId === reorderSelectedId) {
                vignette.classList.add('reorder-selected');
                
                // Remover y agregar indicador
                const existingIndicator = vignette.querySelector('.reorder-indicator');
                if (!existingIndicator) {
                    const indicator = document.createElement('div');
                    indicator.className = 'reorder-indicator';
                    indicator.textContent = '1Ô∏è‚É£';
                    vignette.appendChild(indicator);
                }
            }
            
            if (noteId === reorderTargetId) {
                vignette.classList.add('reorder-target');
                
                // Agregar flecha ‚¨ÖÔ∏è
                const arrow = document.createElement('div');
                arrow.className = 'reorder-arrow';
                arrow.textContent = '‚¨ÖÔ∏è';
                vignette.appendChild(arrow);
            }
        });
    }

    function updateReorderInstructions() {
        const instructions = document.getElementById('reorder-instructions');
        if (!instructions) return;
        
        if (isReorderMode) {
            instructions.classList.add('active');
            if (reorderSelectedId === null) {
                instructions.innerHTML = `
                    <h3>üìã Modo Reordenamiento Activo</h3>
                    <p>1. <strong>Haz clic</strong> en una nota para seleccionarla (se pondr√° verde)</p>
                    <p>2. <strong>Mueve el mouse</strong> sobre otra nota para definir la posici√≥n</p>
                    <p>3. <strong>Haz clic</strong> en la segunda nota para posicionar la seleccionada</p>
                    <div class="steps">
                        <span class="step">Primer clic: Seleccionar</span>
                        <span class="step">Mouseover: Previsualizar</span>
                        <span class="step">Segundo clic: Posicionar</span>
                    </div>
                `;
            } else {
                const selectedNote = state.notes[reorderSelectedId];
                instructions.innerHTML = `
                    <h3>‚úÖ Nota Seleccionada</h3>
                    <p><strong>Seleccionada:</strong> "${selectedNote?.title || 'Sin t√≠tulo'}"</p>
                    <p><strong>Instrucci√≥n:</strong> Haz clic en otra nota para moverla all√≠ (se mostrar√° una flecha ‚¨ÖÔ∏è)</p>
                `;
            }
        } else {
            instructions.classList.remove('active');
        }
    }

    // ========== FUNCIONES DE LA PIZARRA ==========
    function loadSnippetToBoard(noteId) {
        const note = state.notes[noteId];
        if (!note) return;
        
        if (currentBoardSnippet === noteId) {
            document.getElementById('board-code').value = originalBoardCode;
            return;
        }
        
        currentBoardSnippet = noteId;
        originalBoardCode = note.code;
        
        document.getElementById('board-empty').style.display = 'none';
        document.getElementById('board-content').style.display = 'flex';
        document.getElementById('board-title').textContent = note.title || 'Sin t√≠tulo';
        
        // Mostrar descripci√≥n en la pizarra (color naranja)
        const descriptionEl = document.getElementById('board-description');
        if (descriptionEl) {
            descriptionEl.textContent = note.description || '';
            if (!note.description) {
                descriptionEl.style.display = 'none';
            } else {
                descriptionEl.style.display = 'block';
            }
        }
        
        const tagsContainer = document.getElementById('board-tags');
        if (tagsContainer) {
            tagsContainer.innerHTML = '';
            if (note.tags && Array.isArray(note.tags) && note.tags.length > 0) {
                note.tags.forEach(tag => {
                    if (!tag || typeof tag !== 'string') return;
                    const tagElement = document.createElement('span');
                    tagElement.className = 'board-tag';
                    tagElement.textContent = tag;
                    tagsContainer.appendChild(tagElement);
                });
            }
        }
        
        const boardCode = document.getElementById('board-code');
        if (boardCode) {
            boardCode.value = note.code || '';
        }
    }

    window.copyBoardCode = function() {
        const boardCode = document.getElementById('board-code');
        if (boardCode && boardCode.value) {
            navigator.clipboard.writeText(boardCode.value);
            const copyBtn = document.querySelector('.board-btn');
            if (copyBtn) {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úì Copiado!';
                copyBtn.style.background = '#2ecc71';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 1500);
            }
        }
    };

    window.clearBoard = function() {
        currentBoardSnippet = null;
        originalBoardCode = "";
        const boardEmpty = document.getElementById('board-empty');
        const boardContent = document.getElementById('board-content');
        if (boardEmpty) boardEmpty.style.display = 'flex';
        if (boardContent) boardContent.style.display = 'none';
        
        const boardTitle = document.getElementById('board-title');
        if (boardTitle) boardTitle.textContent = 'Pizarra de C√≥digo';
        
        const boardDescription = document.getElementById('board-description');
        if (boardDescription) boardDescription.textContent = '';
        
        const boardTags = document.getElementById('board-tags');
        if (boardTags) boardTags.innerHTML = '';
    };

    // ========== MODAL FUNCTIONS ==========
    window.openModal = function(noteId = null) {
        editingSnippetId = noteId;
        const modal = document.getElementById('modal-overlay');
        const titleInput = document.getElementById('modal-title');
        
        if (!modal || !titleInput) return;
        
        if (noteId !== null) {
            titleInput.textContent = 'Editar Nota';
            const note = state.notes[noteId];
            if (note) {
                document.getElementById('snippet-title').value = note.title || '';
                document.getElementById('snippet-description').value = note.description || '';
                document.getElementById('snippet-image').value = note.image || '';
                document.getElementById('snippet-code').value = note.code || '';
                currentTags = note.tags && Array.isArray(note.tags) ? [...note.tags] : [];
            }
        } else {
            titleInput.textContent = 'Nueva Nota';
            document.getElementById('snippet-title').value = '';
            document.getElementById('snippet-description').value = '';
            document.getElementById('snippet-image').value = '';
            document.getElementById('snippet-code').value = '';
            currentTags = [];
        }
        
        renderTags();
        modal.classList.add('active');
        document.getElementById('snippet-title').focus();
    };

    window.closeModal = function() {
        const modal = document.getElementById('modal-overlay');
        if (modal) modal.classList.remove('active');
        editingSnippetId = null;
        currentTags = [];
    };

    function renderTags() {
        const tagDisplay = document.getElementById('tag-display');
        if (!tagDisplay) return;
        
        tagDisplay.innerHTML = '';
        currentTags.forEach((tag, index) => {
            if (!tag || typeof tag !== 'string') return;
            const tagElement = document.createElement('span');
            tagElement.className = 'input-tag';
            tagElement.innerHTML = `
                ${tag}
                <span class="remove-tag" onclick="removeTag(${index})">√ó</span>
            `;
            tagDisplay.appendChild(tagElement);
        });
    }

    window.updateTagSuggestions = function() {
        const input = document.getElementById('tag-input');
        const suggestionsBox = document.getElementById('tag-suggestions');
        if (!input || !suggestionsBox) return;
        
        const searchTerm = input.value.trim().toLowerCase();
        if (!searchTerm) {
            suggestionsBox.classList.remove('active');
            return;
        }
        
        const filteredTags = Array.from(allTags).filter(tag => 
            tag && typeof tag === 'string' && tag.includes(searchTerm) && !currentTags.includes(tag)
        );
        
        suggestionsBox.innerHTML = '';
        if (filteredTags.length > 0) {
            filteredTags.forEach(tag => {
                const suggestion = document.createElement('div');
                suggestion.className = 'tag-suggestion';
                suggestion.textContent = tag;
                suggestion.onclick = () => {
                    if (!currentTags.includes(tag)) {
                        currentTags.push(tag);
                        renderTags();
                        input.value = '';
                        suggestionsBox.classList.remove('active');
                    }
                };
                suggestionsBox.appendChild(suggestion);
            });
            suggestionsBox.classList.add('active');
        } else {
            suggestionsBox.classList.remove('active');
        }
    };

    window.removeTag = function(index) {
        if (index >= 0 && index < currentTags.length) {
            currentTags.splice(index, 1);
            renderTags();
        }
    };

    window.saveSnippet = function() {
        const titleInput = document.getElementById('snippet-title');
        const descriptionInput = document.getElementById('snippet-description');
        const imageInput = document.getElementById('snippet-image');
        const codeInput = document.getElementById('snippet-code');
        
        if (!titleInput || !codeInput) return;
        
        const title = titleInput.value.trim();
        const description = descriptionInput ? descriptionInput.value.trim() : '';
        const image = imageInput ? imageInput.value.trim() : '';
        const code = codeInput.value.trim();
        
        if (!title || !code) {
            alert('T√≠tulo y c√≥digo son obligatorios');
            return;
        }
        
        if (!state.settings.activeFolderId) {
            alert('Primero selecciona o crea una carpeta');
            return;
        }
        
        const noteData = {
            id: editingSnippetId || generate5DigitId(),
            title: title,
            description: description,
            image: image || '',
            code: code,
            tags: currentTags.filter(tag => tag && typeof tag === 'string' && tag.trim()),
            date: Date.now()
        };
        
        if (editingSnippetId !== null) {
            state.notes[editingSnippetId] = noteData;
        } else {
            state.notes[noteData.id] = noteData;
            
            const activeFolder = state.folders.find(f => f && f.id === state.settings.activeFolderId);
            if (activeFolder) {
                if (!activeFolder.noteOrder) {
                    activeFolder.noteOrder = [];
                }
                activeFolder.noteOrder.push(noteData.id);
            }
        }
        
        saveLocal();
        closeModal();
        render();
        
        // Si esta nota est√° actualmente en la pizarra, actualizarla
        if (currentBoardSnippet === noteData.id) {
            loadSnippetToBoard(noteData.id);
        }
    };

    // ========== CONTEXT MENU FUNCTIONS ==========
    function showContextMenu(x, y) {
        const menu = document.getElementById('context-menu');
        if (!menu) return;
        
        menu.style.display = 'block';
        menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
        menu.style.top = Math.min(y, window.innerHeight - 150) + 'px';
    }

    function showVignetteContextMenu(x, y) {
        const menu = document.getElementById('vignette-context-menu');
        if (!menu) return;
        
        menu.style.display = 'block';
        menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
        menu.style.top = Math.min(y, window.innerHeight - 150) + 'px';
    }

    window.onclick = function(e) {
        const contextMenu = document.getElementById('context-menu');
        const vignetteMenu = document.getElementById('vignette-context-menu');
        
        if (contextMenu && contextMenu.style.display === 'block' && 
            !contextMenu.contains(e.target)) {
            contextMenu.style.display = 'none';
        }
        
        if (vignetteMenu && vignetteMenu.style.display === 'block' && 
            !vignetteMenu.contains(e.target)) {
            vignetteMenu.style.display = 'none';
        }
    };

    window.editVignette = function() {
        if (selectedVignetteId !== null) {
            openModal(selectedVignetteId);
            const menu = document.getElementById('vignette-context-menu');
            if (menu) menu.style.display = 'none';
        }
    };

    window.copyVignetteCode = function() {
        if (selectedVignetteId !== null) {
            const note = state.notes[selectedVignetteId];
            if (note && note.code) {
                navigator.clipboard.writeText(note.code);
                const menu = document.getElementById('vignette-context-menu');
                if (menu) {
                    const menuBtn = menu.querySelector('button:nth-child(2)');
                    if (menuBtn) {
                        const originalText = menuBtn.textContent;
                        menuBtn.textContent = '‚úì Copiado!';
                        setTimeout(() => {
                            menuBtn.textContent = originalText;
                        }, 1000);
                    }
                }
            }
        }
    };

    window.deleteVignette = function() {
        if (selectedVignetteId !== null && confirm('¬øEliminar esta nota?')) {
            delete state.notes[selectedVignetteId];
            
            if (state.folders && Array.isArray(state.folders)) {
                state.folders.forEach(folder => {
                    if (folder && folder.noteOrder && Array.isArray(folder.noteOrder)) {
                        const index = folder.noteOrder.indexOf(selectedVignetteId);
                        if (index !== -1) {
                            folder.noteOrder.splice(index, 1);
                        }
                    }
                });
            }
            
            saveLocal();
            const menu = document.getElementById('vignette-context-menu');
            if (menu) menu.style.display = 'none';
            
            if (currentBoardSnippet === selectedVignetteId) {
                clearBoard();
            }
            
            render();
        }
    };

    // ========== CATEGORY FUNCTIONS ==========
    window.handleSearch = () => { 
        const searchInput = document.getElementById('main-search');
        if (searchInput) {
            state.settings.searchTerm = searchInput.value; 
            render(); 
        }
    };
    
    window.renameCategory = () => {
        if (!selectedCatContext) return;
        const folder = state.folders.find(f => f && f.id === selectedCatContext);
        if (!folder) return;
        
        const n = prompt("Nuevo nombre:", folder.name || '');
        if(n && n.trim()) {
            folder.name = n.trim();
            saveLocal();
            render();
        }
    };

    window.setBackground = () => {
        if (!selectedCatContext) return;
        const folder = state.folders.find(f => f && f.id === selectedCatContext);
        if (!folder) return;
        
        const url = prompt("URL de la imagen (deja vac√≠o para eliminar):", folder.bg || "");
        if(url !== null) { 
            folder.bg = url.trim();
            saveLocal();
            render();
        }
    };

    window.deleteCategory = () => {
        if (!selectedCatContext) return;
        const folder = state.folders.find(f => f && f.id === selectedCatContext);
        if (!folder) return;
        
        if(confirm(`¬øEliminar la carpeta "${folder.name || 'Sin nombre'}" y todas sus notas?`)) {
            state.folders = state.folders.filter(f => f && f.id !== selectedCatContext);
            
            if (state.settings.activeFolderId === selectedCatContext) {
                state.settings.activeFolderId = state.folders.length > 0 ? state.folders[0].id : null;
            }
            
            saveLocal();
            clearBoard();
            render();
        }
    };

    window.addCategory = function() {
        const n = prompt("Nombre de la carpeta:");
        if(n && n.trim()) {
            if (!state.folders) {
                state.folders = [];
            }
            
            const newFolder = {
                id: 'folder_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: n.trim(),
                bg: "",
                noteOrder: []
            };
            
            state.folders.push(newFolder);
            state.settings.activeFolderId = newFolder.id;
            saveLocal();
            render();
        }
    };

    // ========== FIREBASE FUNCTIONS ==========
    window.saveToFirebase = async function() {
        try {
            const dbRef = ref(db, 'vaultData');
            state.settings.lastUpdated = Date.now();
            await set(dbRef, state);
            alert('‚úÖ Datos guardados en Firebase correctamente');
        } catch (error) {
            console.error("Error al guardar en Firebase:", error);
            alert('‚ùå Error al guardar en Firebase: ' + error.message);
        }
    };

    window.loadFromFirebase = async function() {
        if (!confirm('¬øCargar datos desde Firebase? Se perder√°n los datos locales no guardados.')) {
            return;
        }
        
        try {
            const dbRef = ref(db, 'vaultData');
            const snapshot = await get(dbRef);
            
            if (snapshot.exists()) {
                const cloudData = snapshot.val();
                if (cloudData) {
                    state = {
                        folders: Array.isArray(cloudData.folders) ? cloudData.folders : [],
                        notes: cloudData.notes && typeof cloudData.notes === 'object' ? cloudData.notes : {},
                        settings: {
                            activeFolderId: cloudData.settings?.activeFolderId || null,
                            searchTerm: cloudData.settings?.searchTerm || "",
                            lastUpdated: cloudData.settings?.lastUpdated || null,
                            vignetteSize: cloudData.settings?.vignetteSize || "medium"
                        }
                    };
                }
                saveLocal();
                render();
                alert('‚úÖ Datos cargados desde Firebase correctamente');
            } else {
                alert('‚ö†Ô∏è No hay datos guardados en Firebase');
            }
        } catch (error) {
            console.error("Error al cargar desde Firebase:", error);
            alert('‚ùå Error al cargar desde Firebase: ' + error.message);
        }
    };

    // ========== AUXILIARY FUNCTIONS ==========
    function updateAllTags() {
        allTags.clear();
        if (state.notes && typeof state.notes === 'object') {
            Object.values(state.notes).forEach(note => {
                if (note && note.tags && Array.isArray(note.tags)) {
                    note.tags.forEach(tag => {
                        if (tag && typeof tag === 'string' && tag.trim()) {
                            allTags.add(tag.trim().toLowerCase());
                        }
                    });
                }
            });
        }
        const countEl = document.getElementById('existing-tags-count');
        if (countEl) countEl.textContent = allTags.size;
    }

    function saveLocal() { 
        try {
            localStorage.setItem('vaultCache', JSON.stringify(state));
        } catch (e) {
            console.error("Error al guardar localmente:", e);
        }
    }

    // ========== INITIALIZATION ==========
    function initApp() {
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isReorderMode) {
                exitReorderMode();
            }
        });

        document.addEventListener('click', function(e) {
            if (isReorderMode && !e.target.closest('.vignette') && !e.target.closest('.ui-btn[title*="Cancelar"]')) {
                if (reorderSelectedId !== null) {
                    exitReorderMode();
                }
            }
        });

        const tagInput = document.getElementById('tag-input');
        if (tagInput) {
            tagInput.addEventListener('keydown', function(e) {
                if (e.key === ',' || e.key === 'Enter') {
                    e.preventDefault();
                    const tag = this.value.trim();
                    if (tag && !currentTags.includes(tag)) {
                        currentTags.push(tag);
                        renderTags();
                        this.value = '';
                    }
                }
            });
            
            tagInput.addEventListener('blur', function() {
                const tag = this.value.trim();
                if (tag && !currentTags.includes(tag)) {
                    currentTags.push(tag);
                    renderTags();
                    this.value = '';
                }
            });
        }
        
        const boardCode = document.getElementById('board-code');
        if (boardCode) {
            boardCode.addEventListener('input', function() {});
        }
        
        // Aplicar tama√±o inicial de vi√±etas
        applyVignetteSize();
        updateAllTags();
        render();
        
        // Configurar botones de tama√±o seg√∫n configuraci√≥n guardada
        setTimeout(() => {
            changeVignetteSize(state.settings.vignetteSize);
        }, 100);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
    } else {
        initApp();
    }
</script>
</body>
</html>
